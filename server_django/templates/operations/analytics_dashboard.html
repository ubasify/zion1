{% extends 'base.html' %}
{% load humanize %}

{% block content %}
<div x-data="{ currentTab: 'overview' }" class="min-h-screen bg-slate-50 dark:bg-slate-900 font-sans pb-12">

    <!-- Header -->
    <div
        class="flex items-center justify-between px-6 py-6 border-b border-slate-200 dark:border-slate-800 bg-white dark:bg-slate-900 sticky top-0 z-30">
        <div class="flex items-center gap-4">
            <div
                class="w-10 h-10 bg-brand-navy rounded-lg flex items-center justify-center text-white font-bold shadow-lg shadow-brand-navy/20">
                <i data-lucide="bar-chart-2" class="w-5 h-5"></i>
            </div>
            <div>
                <h1 class="text-xl font-bold text-slate-900 dark:text-white leading-tight">Analytics Dashboard</h1>
                <p class="text-xs text-slate-500 dark:text-slate-400">Insights & Performance Metrics</p>
            </div>
        </div>

        <!-- Tab Navigation -->
        <div class="flex bg-slate-100 dark:bg-slate-800 rounded-lg p-1">
            <button @click="currentTab = 'overview'"
                :class="currentTab == = 'overview' ? 'bg-white dark:bg-slate-700 text-brand-navy dark:text-white shadow-sm' : 'text-slate-600 dark:text-slate-400 hover:text-slate-900 dark:hover:text-white'"
                class="px-4 py-1.5 text-sm font-medium rounded-md transition-all">Overview</button>
            <button @click="currentTab = 'attendance'"
                :class="currentTab == = 'attendance' ? 'bg-white dark:bg-slate-700 text-brand-navy dark:text-white shadow-sm' : 'text-slate-600 dark:text-slate-400 hover:text-slate-900 dark:hover:text-white'"
                class="px-4 py-1.5 text-sm font-medium rounded-md transition-all">Attendance</button>
            <button @click="currentTab = 'finance'"
                :class="currentTab == = 'finance' ? 'bg-white dark:bg-slate-700 text-brand-navy dark:text-white shadow-sm' : 'text-slate-600 dark:text-slate-400 hover:text-slate-900 dark:hover:text-white'"
                class="px-4 py-1.5 text-sm font-medium rounded-md transition-all">Finance</button>
            <button @click="currentTab = 'people'"
                :class="currentTab == = 'people' ? 'bg-white dark:bg-slate-700 text-brand-navy dark:text-white shadow-sm' : 'text-slate-600 dark:text-slate-400 hover:text-slate-900 dark:hover:text-white'"
                class="px-4 py-1.5 text-sm font-medium rounded-md transition-all">People</button>
        </div>
    </div>

    <div class="max-w-7xl mx-auto px-6 mt-8">

        <!-- OVERVIEW TAB -->
        <div x-show="currentTab == = 'overview'" x-transition.opacity>
            <h2 class="text-lg font-bold text-slate-900 dark:text-white mb-4">Executive Summary</h2>

            <!-- KPI Cards -->
            <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
                <!-- Attendance KPI -->
                <div
                    class="bg-white dark:bg-slate-800 rounded-xl p-6 shadow-sm border border-slate-100 dark:border-slate-700">
                    <div class="flex justify-between items-start mb-4">
                        <div>
                            <p class="text-sm font-medium text-slate-500 dark:text-slate-400">Avg Weekly Attendance</p>
                            <h3 class="text-3xl font-bold text-slate-900 dark:text-white mt-1">{{ attendance_metrics.avg_weekly }}</h3>
                        </div>
                        <div class="p-2 bg-blue-50 dark:bg-blue-900/20 text-blue-600 rounded-lg">
                            <i data-lucide="users" class="w-5 h-5"></i>
                        </div>
                    </div>
                </div>

                <!-- Finance KPI -->
                <div
                    class="bg-white dark:bg-slate-800 rounded-xl p-6 shadow-sm border border-slate-100 dark:border-slate-700">
                    <div class="flex justify-between items-start mb-4">
                        <div>
                            <p class="text-sm font-medium text-slate-500 dark:text-slate-400">Total Income (YTD)</p>
                            <h3 class="text-3xl font-bold text-slate-900 dark:text-white mt-1">Â£{{ finance_metrics.total_ytd|intcomma }}</h3>
                        </div>
                        <div class="p-2 bg-green-50 dark:bg-green-900/20 text-green-600 rounded-lg">
                            <i data-lucide="pound-sterling" class="w-5 h-5"></i>
                        </div>
                    </div>
                </div>

                <!-- Members KPI -->
                <div
                    class="bg-white dark:bg-slate-800 rounded-xl p-6 shadow-sm border border-slate-100 dark:border-slate-700">
                    <div class="flex justify-between items-start mb-4">
                        <div>
                            <p class="text-sm font-medium text-slate-500 dark:text-slate-400">Total Members</p>
                            <h3 class="text-3xl font-bold text-slate-900 dark:text-white mt-1">{{ member_metrics.total_members }}</h3>
                        </div>
                        <div class="p-2 bg-purple-50 dark:bg-purple-900/20 text-purple-600 rounded-lg">
                            <i data-lucide="user-plus" class="w-5 h-5"></i>
                        </div>
                    </div>
                    <p class="text-xs text-green-600 flex items-center gap-1">
                        <i data-lucide="trending-up" class="w-3 h-3"></i> +{{ member_metrics.new_ytd }} New this year
                    </p>
                </div>
            </div>

            <!-- Main Charts Row -->
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                <!-- Attendance Trend -->
                <div
                    class="bg-white dark:bg-slate-800 rounded-xl p-6 shadow-sm border border-slate-100 dark:border-slate-700">
                    <h3 class="text-sm font-bold text-slate-900 dark:text-white mb-6">Attendance Trend (12 Months)</h3>
                    <canvas id="overviewAttendanceChart" height="250"></canvas>
                </div>

                <!-- Income Breakdown -->
                <div
                    class="bg-white dark:bg-slate-800 rounded-xl p-6 shadow-sm border border-slate-100 dark:border-slate-700">
                    <h3 class="text-sm font-bold text-slate-900 dark:text-white mb-6">Income by Category (YTD)</h3>
                    <div class="h-[250px] flex items-center justify-center">
                        <canvas id="overviewFinanceChart"></canvas>
                    </div>
                </div>
            </div>
        </div>

        <!-- ATTENDANCE TAB -->
        <div x-show="currentTab == = 'attendance'" x-cloak>
            <h2 class="text-lg font-bold text-slate-900 dark:text-white mb-4">Attendance Analysis</h2>
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                <div
                    class="bg-white dark:bg-slate-800 rounded-xl p-6 shadow-sm border border-slate-100 dark:border-slate-700">
                    <h3 class="text-sm font-bold text-slate-900 dark:text-white mb-6">Average by Service Type</h3>
                    <canvas id="attendanceSplitChart" height="250"></canvas>
                </div>
            </div>
        </div>

        <!-- FINANCE TAB -->
        <div x-show="currentTab == = 'finance'" x-cloak>
            <h2 class="text-lg font-bold text-slate-900 dark:text-white mb-4">Financial Analysis</h2>
            <div
                class="bg-white dark:bg-slate-800 rounded-xl p-6 shadow-sm border border-slate-100 dark:border-slate-700 mb-6">
                <h3 class="text-sm font-bold text-slate-900 dark:text-white mb-6">Monthly Income Trend</h3>
                <canvas id="financeTrendChart" height="300"></canvas>
            </div>
        </div>

        <!-- PEOPLE TAB -->
        <div x-show="currentTab == = 'people'" x-cloak>
            <h2 class="text-lg font-bold text-slate-900 dark:text-white mb-4">Demographics & Growth</h2>
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                <div
                    class="bg-white dark:bg-slate-800 rounded-xl p-6 shadow-sm border border-slate-100 dark:border-slate-700">
                    <h3 class="text-sm font-bold text-slate-900 dark:text-white mb-6">Membership Status Distribution
                    </h3>
                    <div class="h-[300px] flex justify-center">
                        <canvas id="memberStatusChart"></canvas>
                    </div>
                </div>
            </div>
        </div>

    </div>
</div>
{% endblock %}

{% block extra_head %}
<!-- Chart.js -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script defer src="https://cdn.jsdelivr.net/npm/alpinejs@3.x.x/dist/cdn.min.js"></script>

<script>
    document.addEventListener('DOMContentLoaded', function () {

        // --- DATA INJECTION ---
        const attendanceLabels = JSON.parse('{{ attendance_metrics.trend_labels|safe }}');
        const attendanceData = JSON.parse('{{ attendance_metrics.trend_data|safe }}');

        const financeLabels = JSON.parse('{{ finance_metrics.category_labels|safe }}');
        const financeData = JSON.parse('{{ finance_metrics.category_data|safe }}');

        const financeTrendLabels = JSON.parse('{{ finance_metrics.trend_labels|safe }}');
        const financeTrendData = JSON.parse('{{ finance_metrics.trend_data|safe }}');

        const memberLabels = JSON.parse('{{ member_metrics.status_labels|safe }}');
        const memberData = JSON.parse('{{ member_metrics.status_data|safe }}');

        const sundayAvg = {{ attendance_metrics.sunday_avg }
    };
    const midweekAvg = {{ attendance_metrics.midweek_avg }};

    // --- CHART CONFIGS ---

    // 1. Overview Attendance Trend
    new Chart(document.getElementById('overviewAttendanceChart'), {
        type: 'line',
        data: {
            labels: attendanceLabels,
            datasets: [{
                label: 'Total Attendance',
                data: attendanceData,
                borderColor: '#4F46E5', // brand-navy
                backgroundColor: 'rgba(79, 70, 229, 0.1)',
                tension: 0.4,
                fill: true
            }]
        },
        options: { responsive: true, plugins: { legend: { display: false } } }
    });

    // 2. Overview Finance Pie
    new Chart(document.getElementById('overviewFinanceChart'), {
        type: 'doughnut',
        data: {
            labels: financeLabels,
            datasets: [{
                data: financeData,
                backgroundColor: ['#4F46E5', '#10B981', '#F59E0B', '#6366F1', '#EC4899'],
                borderWidth: 0
            }]
        },
        options: { responsive: true, maintainAspectRatio: false }
    });

    // 3. Attendance Split Bar
    new Chart(document.getElementById('attendanceSplitChart'), {
        type: 'bar',
        data: {
            labels: ['Sunday Service', 'Midweek Service'],
            datasets: [{
                label: 'Avg Attendance',
                data: [sundayAvg, midweekAvg],
                backgroundColor: ['#4F46E5', '#6366F1'],
                borderRadius: 8
            }]
        },
        options: { responsive: true, scales: { y: { beginAtZero: true } } }
    });

    // 4. Finance Trend Line
    new Chart(document.getElementById('financeTrendChart'), {
        type: 'bar',
        data: {
            labels: financeTrendLabels,
            datasets: [{
                label: 'Monthly Income (Â£)',
                data: financeTrendData,
                backgroundColor: '#10B981',
                borderRadius: 4
            }]
        },
        options: { responsive: true }
    });

    // 5. Member Status Pie
    new Chart(document.getElementById('memberStatusChart'), {
        type: 'pie',
        data: {
            labels: memberLabels,
            datasets: [{
                data: memberData,
                backgroundColor: ['#10B981', '#94A3B8', '#F59E0B', '#6366F1'],
                borderWidth: 1
            }]
        },
        options: { responsive: true, maintainAspectRatio: false }
    });

    });
</script>
{% endblock %}




